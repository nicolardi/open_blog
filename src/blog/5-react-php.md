# Day 5 - react PHP


<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 320 476.037"><path fill="#584b4f" d="M320 406.195l-86.506-155.403c-2.67 1.365-5.377 2.67-8.123 3.908-22.3 10.07-53.39 12.457-69.61 12.995l72.393 138.5H320z"></path><path fill="#4F5B93" d="M255.323 36.793C231.543 12.263 199.5 0 159.193 0h-67.32C58.783 0 35.197 6.942 21.13 20.82 7.055 34.71.022 56.86.022 87.285v318.91h79.3V106.68c0-23.957 11.783-35.94 35.37-35.94h39.364c17.49 0 31.47 5.33 41.932 15.972 10.457 10.652 15.688 24.63 15.688 41.935 0 17.31-5.42 31.763-16.257 43.356-10.844 11.604-24.633 17.398-41.365 17.398h-16.168v-14.664L92.395 222.44l45.493 47.703v-14.54c8.476.042 50.736-.412 78.925-13.144 20.28-9.155 38.51-21.393 52.77-41.36s21.395-43.646 21.395-71.028c0-37.656-11.894-68.744-35.655-93.28z"></path><path d="M30.717 452.275c1.628-2.276 2.442-4.976 2.442-8.096 0-4.294-1.36-7.835-4.068-10.63-2.71-2.8-6.36-4.197-10.953-4.197h-7.674c-3.772 0-6.458.794-8.063 2.377C.803 433.31 0 435.838 0 439.306v36.342h9.038v-17.165h6.5l9.037 17.165h10.47l-10.34-18.66c2.383-.865 4.388-2.436 6.012-4.712zm-8.45-3.318c-1.235 1.323-2.808 1.98-4.712 1.98H9.038v-9.426c0-2.726 1.343-4.094 4.03-4.094h4.487c1.992 0 3.586.607 4.777 1.822 1.192 1.215 1.79 2.808 1.79 4.78 0 1.973-.62 3.623-1.855 4.94zm20.253 14.466c0 4.552 1.05 7.73 3.152 9.527 2.104 1.8 5.755 2.696 10.957 2.696h16.383v-8.062H57.28c-2.17 0-3.663-.346-4.488-1.04-.826-.692-1.235-1.95-1.235-3.77v-6.438h14.367l.652-8.062h-15.02v-10.86h21.458v-8.06H42.52v34.07zm57.7-33.285c-.714-.52-1.657-.783-2.828-.783-1.17 0-2.156.284-2.957.847-.803.563-1.53 1.583-2.18 3.057l-14.822 42.387h9.428l2.537-7.994h15.54l2.6 7.994h9.427l-14.824-42.39c-.565-1.564-1.205-2.6-1.92-3.12zm-8.55 29.906l5.722-18.335 5.463 18.333H91.67zm52.826 5.43c-1.15 1.67-3.23 2.5-6.242 2.5-3.015 0-5.233-.91-6.665-2.728-1.388-1.822-2.083-5.226-2.083-10.207v-4.035c0-1.774.045-3.184.13-4.223.176-3.254.78-5.55 1.823-6.895 1.473-1.905 3.727-2.86 6.762-2.86 2.6 0 4.51.65 5.722 1.95 1.212 1.303 2.06 3.23 2.535 5.787h8.45c0-5.114-1.55-9.028-4.648-11.735-3.1-2.71-7.12-4.065-12.06-4.065-3.383 0-6.265.562-8.647 1.693-6.068 2.77-9.103 9.64-9.103 20.607v3.9c0 13.917 5.917 20.87 17.75 20.87 5.374 0 9.535-1.583 12.482-4.747 2.95-3.162 4.418-7.694 4.418-13.59h-8.386c-.344 3.514-1.095 6.105-2.24 7.774zm14.598-36.12v8.062h12.353v38.23h9.037v-38.23h12.412v-8.062" fill="#584b4f"></path><path d="M217.867 429.354h-17.945v46.292h9.043V460.82h8.902c4.853 0 8.608-1.33 11.276-3.996 2.67-2.666 4-6.577 4-11.733s-1.33-9.07-4-11.733c-2.668-2.667-6.424-4.002-11.276-4.002zm4.518 21.584c-1.147 1.172-2.803 1.76-4.976 1.76h-8.447v-15.282h8.445c4.462 0 6.696 2.56 6.696 7.675 0 2.73-.573 4.68-1.72 5.85zm43.725-2.01h-16.97v-19.574h-9.044v46.292h9.043v-18.72h16.97v18.72h9.034v-46.292h-9.036m48.404 4c-2.67-2.665-6.43-4-11.282-4h-17.944v46.29h9.042v-14.823h8.902c4.853 0 8.613-1.33 11.282-3.995s3.995-6.577 3.995-11.733-1.326-9.07-3.995-11.735zm-6.763 17.584c-1.15 1.172-2.81 1.76-4.977 1.76h-8.446v-15.282h8.446c4.462 0 6.702 2.56 6.702 7.675 0 2.73-.58 4.68-1.727 5.85z" fill="#4F5B93"></path></svg>

[[React PHP](https://reactphp.org/) is a library that allows event-driven programming like in node.js for example using PHP. This library is pretty similar to [Swoole](https://openswoole.com/) but there are some differences between the two. One of them is that Swoole is a PHP plugin written in C language while React PHP is just a PHP library.

What enables PHP to support async operations? Async means that the IO instructions are "not blocking". For example, if the code is for example waiting for a timer to complete or waiting for a webpage to download the program may still perform other operations without blocking the execution.

::: tip
The target of this post is to understand what enables PHP to run async functions since version 5.3.8
:::

Let's dive into the [source code](https://github.com/reactphp/reactphp).

As a first look, I notice that there are too few files than what I was expecting.

In the tests directory, I can see that there's just one bootstrap.php 
So the project is more or less empty... where is the source code then?

Let's open the [composer.json](https://github.com/reactphp/reactphp/blob/master/composer.json) file

```php 
{
    "name": "react/react",
    "description": "ReactPHP: Event-driven, non-blocking I/O with PHP.",
    "keywords": ["reactor", "asynchronous", "ReactPHP"],
    "homepage": "https://reactphp.org/",
    "license": "MIT",
    "support": {
        "chat": "https://gitter.im/reactphp/reactphp"
    },
    "require": {
        "php": ">=5.3.8",
        "react/cache": "^1.0",
        "react/dns": "^1.8",
        "react/event-loop": "^1.2",
        "react/http": "^1.6",
        "react/promise": "^2.1 || ^1.2",
        "react/promise-stream": "^1.1.1",
        "react/promise-timer": "^1.7",
        "react/socket": "^1.9",
        "react/stream": "^1.2"
    },
    "require-dev": {
        "clue/block-react": "^1.1",
        "clue/stream-filter": "^1.3",
        "phpunit/phpunit": "^7.0 || ^6.0 || ^5.7 || ^4.8.35"
    },
    "config": {
        "preferred-install": {
            "react/*": "source"
        }
    }
}
```

Here's the "trick"! the real code has been split in many different independent projects that "fall" under a common GitHub react/ namespace

It is worth noting that this library supports PHP since version 5.3.8 is pretty old. How strange... do PHP support async operations from that version? I didn't know

Let's have a look at one of these projects. I know that the "core" of async operations is the event-loop.
For example, nodejs has the same approach. So I decided to have a look at [reactphp/event-loop]()

::: tip 
Little things to notice...   the package name is "react/event-loop" but the GitHub repo is reactphp/event-loop why? 
Because the package publishing is made using packagist.org. Here's the [package detail](https://packagist.org/packages/react/event-loop). Have a look at the repo URL in the "details" section.  
:::

Here's the composer.json

```php
{
    "name": "react/event-loop",
    "description": "ReactPHP's core reactor event loop that libraries can use for evented I/O.",
    "keywords": ["event-loop", "asynchronous"],
    "license": "MIT",
    "authors": [
        {
            "name": "Christian LÃ¼ck",
            "homepage": "https://clue.engineering/",
            "email": "christian@clue.engineering"
        },
        {
            "name": "Cees-Jan Kiewiet",
            "homepage": "https://wyrihaximus.net/",
            "email": "reactphp@ceesjankiewiet.nl"
        },
        {
            "name": "Jan Sorgalla",
            "homepage": "https://sorgalla.com/",
            "email": "jsorgalla@gmail.com"
        },
        {
            "name": "Chris Boden",
            "homepage": "https://cboden.dev/",
            "email": "cboden@gmail.com"
        }
    ],
    "require": {
        "php": ">=5.3.0"
    },
    "require-dev": {
        "phpunit/phpunit": "^9.3 || ^5.7 || ^4.8.35"
    },
    "suggest": {
        "ext-event": "~1.0 for ExtEventLoop",
        "ext-pcntl": "For signal handling support when using the StreamSelectLoop",
        "ext-uv": "* for ExtUvLoop"
    },
    "autoload": {
        "psr-4": {
            "React\\EventLoop\\": "src"
        }
    },
    "autoload-dev": {
        "psr-4": {
            "React\\Tests\\EventLoop\\": "tests"
        }
    }
}
```

The autoload section suggests that the namespace React\EventLoop is mapped to the src directory

In the readme.md file there is an example showing how to use this library

```php
<?php

use React\EventLoop\Loop;
require __DIR__ . '/vendor/autoload.php';

Loop::addPeriodicTimer(5, function () {
    $memory = memory_get_usage() / 1024;
    $formatted = number_format($memory, 3).'K';
    echo "Current memory usage: {$formatted}\n";
});

```

Since the React\EventLoop is mapped to the src directory I will open the [src/Loop.php](https://github.com/reactphp/event-loop/blob/master/src/Loop.php). Let's see what is the addPeriodicTimer function

::: tip
The addPeriodicTimer is a static function. You may have guessed it from the Loop:: syntax 
:::

The function is defined as follows:

``` php 
 public static function addPeriodicTimer($interval, $callback)
    {
        return self::get()->addPeriodicTimer($interval, $callback);
    }
```

So it calls the corresponding function on self::get() object.

What is self::get? It is a static method 

::: tip
The self keyword is used to call static methods on the same class
:::

```php 
 public static function get()
    {
        if (self::$instance instanceof LoopInterface) {
            return self::$instance;
        }

        self::$instance = $loop = Factory::create();

        // Automatically run loop at end of program, unless already started or stopped explicitly.
        // This is tested using child processes, so coverage is actually 100%, see BinTest.
        // @codeCoverageIgnoreStart
        $hasRun = false;
        $loop->futureTick(function () use (&$hasRun) {
            $hasRun = true;
        });

        $stopped =& self::$stopped;
        register_shutdown_function(function () use ($loop, &$hasRun, &$stopped) {
            // Don't run if we're coming from a fatal error (uncaught exception).
            $error = error_get_last();
            if ((isset($error['type']) ? $error['type'] : 0) & (E_ERROR | E_CORE_ERROR | E_COMPILE_ERROR | E_USER_ERROR | E_RECOVERABLE_ERROR)) {
                return;
            }

            if (!$hasRun && !$stopped) {
                $loop->run();
            }
        });
        // @codeCoverageIgnoreEnd

        return self::$instance;
    }
```

In the code, you can see many interesting things

For example, this method gets an instance of a class using the factory pattern. This is a buzzword to say that you have an instance of a class simply calling a method and not using the new keyword.

you can see this at @line 7 

```php 
self::$instance = $loop = Factory::create();
```

This is a strange syntax but what it basically means is that (reading from right to left) the return value of  Factory::create() is stored in $loop that is then stored in self::$instance. 
It's an example of a double assignment syntax. Nothing weird here!

At the end of the function @line 31 self::$instance is returned;

::: tip 
You can see @line 3 that it "caches" the instance. In other words, if self::$instance is not empty it will return it without creating a new instance. It's a sort of singleton pattern here. 
:::

So the "creator" here is the  [Factory::create()](https://github.com/reactphp/event-loop/blob/master/src/Factory.php) static method.

Let's see it 


```php 
 public static function create()
    {
        $loop = self::construct();

        Loop::set($loop);

        return $loop;
    }
```

It calls a static construct on the Factory class. We're almost done!

```php 
    private static function construct()
    {
        // @codeCoverageIgnoreStart
        if (\function_exists('uv_loop_new')) {
            // only use ext-uv on PHP 7
            return new ExtUvLoop();
        }

        if (\class_exists('libev\EventLoop', false)) {
            return new ExtLibevLoop();
        }

        if (\class_exists('EvLoop', false)) {
            return new ExtEvLoop();
        }

        if (\class_exists('EventBase', false)) {
            return new ExtEventLoop();
        }

        if (\function_exists('event_base_new') && \PHP_MAJOR_VERSION === 5) {
            // only use ext-libevent on PHP 5 for now
            return new ExtLibeventLoop();
        }

        return new StreamSelectLoop();
        // @codeCoverageIgnoreEnd
    }
```

We're done!
you can read that this method checks if some methods are existing and return the corresponding adapter (for example ExtUvLoop ).

The libraries used to create the loop are:

[php-uv](https://github.com/chobie/php-uv) is a php extension that wraps lib-uv library which is used bu by nodejs too

[libev](https://github.com/enki/libev) is an event-loop implementation

[evLoop](https://www.php.net/manual/en/class.evloop.php) is a pecl extension event loop implementation

[EventBase](https://www.php.net/manual/en/class.eventbase.php) is another event loop implementation

[EventBaseNew](http://php.adamharvey.name/manual/tr/function.event-base-new.php) 

If none of the above implementations is available it fallbacks to [Stream](https://www.php.net/manual/en/ref.stream.php) implementation that is available from PHP 4

So reactphp/event-loop is a wrapper that abstracts async functionalities using the common LoopInterface abstraction

The [LoopInterface](https://github.com/reactphp/event-loop/blob/master/src/LoopInterface.php) contains the following methods:

```php 
 public function addReadStream($stream, $listener);
 public function addWriteStream($stream, $listener);
 public function removeReadStream($stream);
 public function removeWriteStream($stream);
 public function addTimer($interval, $callback);
 public function addPeriodicTimer($interval, $callback);
 public function cancelTimer(TimerInterface $timer);
 public function futureTick($listener);
 public function addSignal($signal, $listener);
 public function removeSignal($signal, $listener);
 public function run();
 public function stop();
```

This is "why" in the example, you can call "addPeriodicTimer".

Cheers!

Massimo Nicolardi











